server {
    listen       80;
    listen  [::]:80;
    server_name  moyuapi.codebug.icu;

    rewrite ^(.*) https://$server_name$1 permanent;
}

server {
    listen       443 ssl;
    server_name  moyuapi.codebug.icu;

    ssl_certificate      /etc/nginx/ssl/cert.pem;
    ssl_certificate_key  /etc/nginx/ssl/key.pem;
    ssl_session_cache    shared:SSL:1m;
    ssl_session_timeout  5m;

    ssl_ciphers  HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers  on;

    location / {
         root /usr/share/nginx/fish;
         index index.html;
try_files $uri $uri/ /index.html;
    }


   location /fish/ {
         proxy_pass http://fish:8123/;    
    }

# WebSocket代理配置，处理 wss:// 请求
    location /ws/ {
        proxy_pass http://fish:8090/;  # 后端 WebSocket 服务地址
        proxy_http_version 1.1;  # 使用 HTTP/1.1 协议，WebSocket 需要这个版本
        proxy_set_header Upgrade $http_upgrade;  # 必须设置这些头来支持 WebSocket 协议的升级
        proxy_set_header Connection 'upgrade';  # 维持 WebSocket 连接
        proxy_set_header Host $host;  # 确保 Host 头部传递正确
        proxy_cache_bypass $http_upgrade;  # 禁用缓存
    }
location /minio/ {
        proxy_pass http://api.oss.cqbo.com:19000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # 只允许一个 Access-Control-Allow-Origin 头
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' '*' always;
            add_header 'Access-Control-Max-Age' 3600;
            return 204;
        }

        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' '*' always;
        add_header 'Access-Control-Expose-Headers' 'ETag' always;
    }

location /sogou-api/ {
        proxy_pass https://pic.sogou.com/;
        proxy_set_header Host pic.sogou.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_ssl_server_name on;

        # 解决 CORS 问题
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range";
        add_header Access-Control-Expose-Headers "Content-Length,Content-Range";

        # 处理 OPTIONS 预检请求
        if ($request_method = OPTIONS) {
            return 204;
        }
    }
location /ip-api/ {
        proxy_pass http://ip-api.com/;
        proxy_set_header Host pic.sogou.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_ssl_server_name on;

        # 解决 CORS 问题
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range";
        add_header Access-Control-Expose-Headers "Content-Length,Content-Range";

        # 处理 OPTIONS 预检请求
        if ($request_method = OPTIONS) {
            return 204;
        }
    }
location /holiday/ {
    proxy_pass https://date.appworlds.cn/;
    
    # 保持目标 API 的 Host，避免返回默认网页
    proxy_set_header Host date.appworlds.cn;

    # 伪装成浏览器，防止服务器根据 User-Agent 返回 HTML
    proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";

    # 强制服务器返回 JSON，而不是 HTML
    proxy_set_header Accept "application/json";

    # CORS 允许跨域
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
    add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range";
    add_header Access-Control-Expose-Headers "Content-Length,Content-Range";

    # 处理 OPTIONS 预检请求
    if ($request_method = OPTIONS) {
        return 204;
    }
}


location /img-api/ {
        proxy_pass https://i.111666.best/;
        proxy_set_header Host pic.sogou.com;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_ssl_server_name on;

        # 解决 CORS 问题
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range";
        add_header Access-Control-Expose-Headers "Content-Length,Content-Range";

        # 处理 OPTIONS 预检请求
        if ($request_method = OPTIONS) {
            return 204;
        }
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}